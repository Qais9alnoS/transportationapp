# مهام الواجهة الخلفية (Backend) لتطبيق "مكروجي" - قائمة TODO

هذا المستند يوضح المهام المطلوبة من مطور الواجهة الخلفية لتطبيق "مكروجي". يجب تنفيذ هذه المهام خطوة بخطوة، مع التأكد من اكتمال كل مهمة قبل الانتقال إلى التالية. الهدف هو بناء واجهة خلفية قوية ومستقلة تمامًا، قادرة على توفير جميع البيانات والخدمات اللازمة للواجهة الأمامية ولوحة التحكم الحكومية.

**ملاحظة هامة:** لا يُسمح بتسليم أي جزء من الواجهة الخلفية للواجهة الأمامية قبل الانتهاء من جميع المهام المذكورة أدناه واختبارها بشكل كامل. يجب أن تكون الواجهة الخلفية جاهزة للعمل بشكل مستقل قبل بدء عملية الربط.

## المرحلة 1: إعداد البيئة وقاعدة البيانات الأساسية

*   **[ ] المهمة 1.1: إعداد بيئة التطوير الأساسية.**
    *   تثبيت Python 3.x.
    *   تثبيت FastAPI.
    *   تثبيت PostgreSQL.
    *   إنشاء مشروع FastAPI جديد.
    *   إعداد ملفات الإعدادات الأساسية (`config/`).
    *   إعداد ملفات البيئة (`.env`).

*   **[ ] المهمة 1.2: تصميم قاعدة بيانات PostgreSQL.**
    *   تصميم جداول البيانات لـ:
        *   `Routes`: لتخزين معلومات خطوط المكاري (ID, Name, Description, Price, OperatingHours).
        *   `Stops`: لتخزين معلومات المحطات (ID, Name, Lat, Lng).
        *   `RouteStops`: جدول وسيط لربط الخطوط بالمحطات وترتيبها.
        *   `RoutePaths`: لتخزين نقاط المسار لكل خط (RouteID, Lat, Lng, Order).
        *   `Feedback`: لتخزين ملاحظات المستخدمين وتقييماتهم (ID, Type, Rating, Comment, RouteID, Timestamp).
        *   `Complaints`: لتخزين شكاوى المستخدمين (ID, UserID, RouteID, MakroID, ComplaintText, Status, Timestamp).
        *   `Users`: (اختياري في هذه المرحلة، يمكن إضافته لاحقًا إذا تطلب الأمر تسجيل دخول).
        *   `MakroLocations`: لتخزين مواقع المكاري الحالية (MakroID, Lat, Lng, Timestamp).
        *   `SearchLogs`: لتخزين سجلات البحث عن الطرق (StartLat, StartLng, EndLat, EndLng, FilterType, Timestamp).
    *   استخدام PostGIS لتمكين تخزين البيانات الجغرافية المكانية في جداول `Stops` و `RoutePaths`.

*   **[ ] المهمة 1.3: إعداد الاتصال بقاعدة البيانات.**
    *   تكوين اتصال FastAPI بقاعدة بيانات PostgreSQL باستخدام SQLAlchemy أو ORM مشابه.
    *   إنشاء نماذج (Models) Python للجداول المصممة في المهمة 1.2.

## المرحلة 2: إدارة بيانات خطوط المكاري

*   **[ ] المهمة 2.1: إنشاء API لإدارة خطوط المكاري (CRUD).**
    *   `POST /api/v1/routes`: لإضافة خط مكرو جديد (مع مساره ومحطاته).
    *   `GET /api/v1/routes`: لجلب جميع خطوط المكاري (مع إمكانية التصفية أو البحث).
    *   `GET /api/v1/routes/{route_id}`: لجلب تفاصيل خط مكرو محدد.
    *   `PUT /api/v1/routes/{route_id}`: لتحديث معلومات خط مكرو.
    *   `DELETE /api/v1/routes/{route_id}`: لحذف خط مكرو.
    *   يجب أن تدعم هذه الـ APIs إدخال وتخزين البيانات الجغرافية المكانية بشكل صحيح.

*   **[ ] المهمة 2.2: تعبئة قاعدة البيانات ببيانات تجريبية.**
    *   إدخال بيانات لعدد قليل من خطوط المكاري، المحطات، والمسارات لغرض الاختبار.

## المرحلة 3: منطق البحث عن المسارات (Online)

*   **[ ] المهمة 3.1: تطوير خدمة حساب المسارات الأساسية.**
    *   إنشاء خدمة (Service) تقوم بحساب المسارات الممكنة بين نقطتي بداية ونهاية باستخدام بيانات خطوط المكاري المخزنة.
    *   يجب أن تأخذ الخدمة في الاعتبار التبديلات بين الخطوط.
    *   يجب أن تعيد الخدمة مسارات مقترحة تتضمن تفاصيل مثل: خطوط السير، عدد المكاري، الزمن التقريبي، والتكلفة التقديرية.

*   **[ ] المهمة 3.2: دمج خيارات التصفية في خدمة حساب المسارات.**
    *   تعديل الخدمة لدعم خيارات التصفية:
        *   `أسرع طريق` (بناءً على الزمن التقريبي).
        *   `أقل عدد مكاري`.
        *   `أرخص طريق`.
    *   يجب أن تعيد الخدمة 3 خيارات للطرق التي تحقق شروط البحث.

*   **[ ] المهمة 3.3: إنشاء API للبحث عن المسارات.**
    *   `POST /api/v1/search-route`: لاستقبال نقطة البداية، نقطة النهاية، ونوع التصفية، وإرجاع المسارات المقترحة.

## المرحلة 4: ميزات Online إضافية

*   **[ ] المهمة 4.1: تطوير API لتتبع مواقع المكاري.**
    *   `POST /api/v1/makro-locations`: لاستقبال تحديثات مواقع المكاري (من أجهزة تتبع GPS في المكاري).
    *   `GET /api/v1/makro-locations`: لجلب مواقع المكاري الحالية (للاستخدام من قبل الواجهة الأمامية).

*   **[ ] المهمة 4.2: دمج خدمة بيانات الازدحام المروري.**
    *   البحث عن API خارجي لبيانات الازدحام المروري (مثل Google Traffic API أو بديل مناسب لسوريا).
    *   تطوير خدمة (Service) للاتصال بهذا الـ API وجلب بيانات الازدحام.
    *   تعديل خدمة حساب المسارات (المهمة 3.1) لاستخدام بيانات الازدحام في حساب `أسرع طريق`.

*   **[ ] المهمة 4.3: تطوير API لمشاركة الموقع.**
    *   `POST /api/v1/share-location`: لاستقبال طلبات مشاركة الموقع وإرسالها إلى المستلمين (يمكن أن تتضمن إرسال رسائل SMS أو إشعارات دفع).

*   **[ ] المهمة 4.4: تطوير API لـ 


Feedback والملاحظات.**
    *   `POST /api/v1/feedback`: لاستقبال تقييمات وملاحظات المستخدمين وتخزينها في قاعدة البيانات.

## المرحلة 5: لوحة التحكم الحكومية (Dashboard)

*   **[ ] المهمة 5.1: تطوير API لبيانات لوحة التحكم - الإحصائيات الأساسية.**
    *   `GET /api/v1/dashboard/top-routes`: لجلب أكثر 10 طرق طلبًا (بناءً على سجلات البحث).
    *   `GET /api/v1/dashboard/usage-statistics`: لجلب إحصائيات عامة عن استخدام التطبيق (عدد المستخدمين، عدد الرحلات، إلخ).

*   **[ ] المهمة 5.2: تطوير API لبيانات لوحة التحكم - الشكاوى.**
    *   `GET /api/v1/dashboard/complaints`: لجلب قائمة بالشكاوى (مع إمكانية التصفية حسب الحالة، الخط، إلخ).
    *   `PUT /api/v1/dashboard/complaints/{complaint_id}`: لتحديث حالة الشكوى.

*   **[ ] المهمة 5.3: تطوير API لبيانات لوحة التحكم - الخرائط الحرارية والتوصيات.**
    *   `GET /api/v1/dashboard/heatmap-data`: لجلب البيانات اللازمة لإنشاء الخرائط الحرارية لحركة الناس.
    *   `GET /api/v1/dashboard/recommendations`: لجلب توصيات لتوسيع أو تعديل الخطوط (يتطلب منطق تحليل بيانات معقد).

*   **[ ] المهمة 5.4: تأمين الـ APIs الخاصة بلوحة التحكم.**
    *   تطبيق آلية مصادقة وتفويض قوية (مثل JWT) لجميع الـ APIs تحت `/api/v1/dashboard`.

## المرحلة 6: الصيانة والأداء والأمان

*   **[ ] المهمة 6.1: تحسين أداء قاعدة البيانات.**
    *   إضافة فهارس (Indexes) مناسبة للجداول المستخدمة بكثرة في الاستعلامات (خاصة جداول المسارات والمحطات).
    *   تحسين استعلامات SQL لضمان الكفاءة.

*   **[ ] المهمة 6.2: تطبيق التخزين المؤقت (Caching).**
    *   تطبيق التخزين المؤقت لبيانات خطوط المكاري التي لا تتغير كثيرًا لتقليل الحمل على قاعدة البيانات.

*   **[ ] المهمة 6.3: تطبيق HTTPS.**
    *   التأكد من أن جميع الاتصالات مع الواجهة الخلفية تتم عبر HTTPS.

*   **[ ] المهمة 6.4: التحقق من صحة المدخلات (Input Validation).**
    *   تطبيق التحقق الشامل من صحة جميع المدخلات الواردة من الواجهة الأمامية لمنع الثغرات الأمنية.

*   **[ ] المهمة 6.5: إعداد التسجيل (Logging).**
    *   إعداد نظام تسجيل فعال لتتبع الأخطاء والعمليات الهامة.

*   **[ ] المهمة 6.6: إعداد النشر (Deployment).**
    *   إعداد Dockerfile و Docker Compose (أو ما يعادلهما) لنشر الواجهة الخلفية بسهولة.

## المرحلة 7: الاختبارات النهائية

*   **[ ] المهمة 7.1: كتابة اختبارات الوحدة (Unit Tests).**
    *   كتابة اختبارات شاملة لجميع الخدمات والـ APIs لضمان عملها بشكل صحيح.

*   **[ ] المهمة 7.2: كتابة اختبارات التكامل (Integration Tests).**
    *   اختبار التكامل بين الـ APIs وقاعدة البيانات.

*   **[ ] المهمة 7.3: اختبار الأداء (Performance Testing).**
    *   إجراء اختبارات أداء لضمان قدرة الواجهة الخلفية على التعامل مع عدد كبير من الطلبات.

*   **[ ] المهمة 7.4: مراجعة الكود (Code Review).**
    *   مراجعة الكود لضمان الجودة، قابلية الصيانة، والالتزام بأفضل الممارسات.

---

## المرحلة 8: المهام المتبقية والتحسينات النهائية

*   **[ ] المهمة 8.1: تطوير APIs لوحة التحكم الحكومية (Dashboard).**
    *   `GET /api/v1/dashboard/top-routes`: جلب أكثر 10 طرق طلبًا.
    *   `GET /api/v1/dashboard/usage-statistics`: إحصائيات عامة عن الاستخدام.
    *   `GET /api/v1/dashboard/complaints`: جلب الشكاوى مع التصفية.
    *   `PUT /api/v1/dashboard/complaints/{complaint_id}`: تحديث حالة الشكوى.
    *   `GET /api/v1/dashboard/heatmap-data`: بيانات الخرائط الحرارية.
    *   `GET /api/v1/dashboard/recommendations`: توصيات الخطوط.

*   **[ ] المهمة 8.2: تأمين APIs لوحة التحكم الحكومية.**
    *   تقييد الوصول للوحة التحكم للمسؤولين فقط (JWT + صلاحيات).

*   **[ ] المهمة 8.3: تحسين أداء قاعدة البيانات.**
    *   إضافة فهارس (Indexes) للجداول المهمة.
    *   تحسين الاستعلامات الأكثر استخدامًا.

*   **[ ] المهمة 8.4: تطبيق التخزين المؤقت (Caching).**
    *   تخزين بيانات خطوط المكاري الثابتة مؤقتًا.
    *   دراسة استخدام Redis أو آلية مشابهة.

*   **[ ] المهمة 8.5: إعداد التسجيل (Logging).**
    *   إضافة نظام تسجيل فعال للأخطاء والعمليات الهامة.

*   **[ ] المهمة 8.6: إعداد النشر (Deployment).**
    *   إعداد Dockerfile و Docker Compose.
    *   توثيق خطوات النشر.

*   **[ ] المهمة 8.7: تعزيز التحقق من صحة المدخلات.**
    *   مراجعة جميع نقاط النهاية والتأكد من التحقق الصارم للمدخلات.

*   **[ ] المهمة 8.8: كتابة اختبارات شاملة (وحدة/تكامل/أداء).**
    *   تغطية جميع الخدمات والـ APIs باختبارات قوية.

*   **[ ] المهمة 8.9: مراجعة الكود النهائية (Final Code Review).**
    *   مراجعة شاملة للكود لضمان الجودة والأمان وقابلية الصيانة.

