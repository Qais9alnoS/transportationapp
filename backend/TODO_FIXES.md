# TODO: إصلاح جميع مشاكل وفشل اختبارات test_comprehensive.py

## 1. مشاكل تسجيل المستخدم/المدير (400 عند التسجيل)
### الوصف:
- تظهر أخطاء مثل: `assert 400 in [200, 201]` عند محاولة تسجيل مستخدم أو مدير جديد في fixture `user_token` أو `admin_token`.
- السبب: بيانات المستخدم (email/username) موجودة مسبقاً في قاعدة البيانات، أو هناك قيود فريدة تمنع التكرار.

### خطوات الحل:
- **تنظيف قاعدة البيانات قبل كل اختبار أو على الأقل قبل كل fixture تسجيل مستخدم/مدير.**
  - استخدم سكريبت مثل `scripts/truncate_all_tables.py` أو أضف fixture pytest يقوم بذلك.
- **توليد بيانات فريدة دائماً:**
  - استخدم uuid أو timestamp في كل من email وusername في كل اختبار.
- **تحقق من أن التسجيل يعيد 201 أو 200 فقط إذا لم يكن هناك تكرار.**
- **في حال فشل التسجيل، اطبع نص الخطأ كاملاً مع البيانات المدخلة لتسهيل التصحيح.

---

## 2. مشاكل التوكنات (401: Could not validate credentials)
### الوصف:
- معظم اختبارات CRUD أو أي اختبار يتطلب صلاحية يرجع 401.
- السبب: التوكن المستخدم غير صالح أو غير مفعّل أو لم يتم توليده بشكل صحيح بسبب فشل التسجيل أو login.

### خطوات الحل:
- **تأكد أن جميع الاختبارات التي تحتاج توكن تستدعي fixture `init_tokens` أو ما شابه.**
- **تحقق من أن التوكنات ليست None قبل استخدامها في أي اختبار.**
- **اطبع التوكنات في بداية كل اختبار مهم للتأكد من صحتها.**
- **إذا كان هناك تغيير في سر التوقيع أو إعدادات JWT، تأكد من مزامنة كل شيء بين backend والاختبارات.**
- **تأكد أن جميع endpoints المحمية تستخدم Depends(get_current_user) أو ما يعادله.**

---

## 3. مشاكل بيانات مكررة (400: سجل makro_id مع نفس الإحداثيات موجود مسبقًا)
### الوصف:
- اختبارات مثل test_create_makro_location أو test_update_makro_location تفشل بسبب تكرار makro_id/lat/lng.
- السبب: البيانات لم تُفرغ بين الاختبارات أو تم استخدام نفس البيانات أكثر من مرة.

### خطوات الحل:
- **نظف جدول makro_locations قبل كل اختبار متعلق به.**
- **استخدم بيانات فريدة (makro_id, lat, lng) في كل اختبار.**
- **أضف تحقق في بداية كل اختبار: إذا كان السجل موجوداً، احذفه أو استخدم makro_id جديد.**

---

## 4. مشاكل protected endpoints (401/403)
### الوصف:
- اختبارات مثل test_update_route, test_delete_route, test_create_stops_bulk, test_optimize_route, test_route_paths_management, test_update_location_share, test_cancel_location_share, وغيرها ترجع 401.
- السبب: التوكن غير صالح أو لم يتم تهيئته بشكل صحيح أو لم يتم تمريره في headers.

### خطوات الحل:
- **تأكد من تمرير headers = {"Authorization": f"Bearer {test_user_token}"} في كل طلب محمي.**
- **تأكد من تهيئة التوكنات بشكل صحيح في كل اختبار (راجع fixture init_tokens).**
- **أضف assert test_user_token is not None في بداية كل اختبار يحتاج توكن.**

---

## 5. مشاكل KeyError: 'access_token' عند login
### الوصف:
- بعض اختبارات login كصديق أو كمدير تفشل لأن الرد لا يحتوي access_token.
- السبب: إما أن بيانات المستخدم غير صحيحة أو لم يتم تسجيل المستخدم/المدير بنجاح.

### خطوات الحل:
- **تحقق من أن بيانات login صحيحة وموجودة فعلاً في قاعدة البيانات.**
- **أضف طباعة r.text عند فشل login لمعرفة السبب الحقيقي.**
- **تأكد من أن تسجيل المستخدم/المدير يتم بنجاح قبل محاولة login.**

---

## 6. مشاكل 422: int_parsing في جلب تقييم/شكوى بالمعرف
### الوصف:
- اختبارات مثل test_get_feedback_by_id, test_get_complaint_by_id ترجع 422 لأن id الممرر None أو غير صحيح.
- السبب: test_feedback_id أو test_complaint_id لم يتم تهيئتهما بنجاح في اختبارات الإنشاء.

### خطوات الحل:
- **تأكد من أن اختبارات الإنشاء (create) تعمل وتخزن id في المتغيرات العامة.**
- **أضف assert test_feedback_id is not None قبل اختبار get.**
- **اطبع id قبل استخدامه في أي اختبار.**

---

## 7. مشاكل الفلاتر غير المدعومة (فلتر بحث)
### الوصف:
- اختبارات مثل test_search_route_invalid_filter ترجع 200 بدلاً من 400/422 عند تمرير فلتر غير مدعوم.
- السبب: endpoint لا يتحقق من صحة الفلتر أو يقبل أي قيمة.

### خطوات الحل:
- **أضف تحقق صريح في backend: إذا كان filter_type غير مدعوم، أرجع 400/422.**
- **حدث اختبار البحث ليتوقع النتيجة الصحيحة فقط إذا كان backend يدعم ذلك.**

---

## 8. مشاكل بيانات قاعدة البيانات (test_empty_routes_list)
### الوصف:
- اختبار test_empty_routes_list يفشل لأن قاعدة البيانات تحتوي خطوطاً افتراضية لم تُحذف.
- السبب: truncate للجداول لا يحذف بيانات seed أو بيانات افتراضية.

### خطوات الحل:
- **تأكد من حذف جميع البيانات (حتى seeded) قبل الاختبار.**
- **أضف DELETE FROM ... لكل جدول مرتبط (routes, stops, route_stops, route_paths, feedback, complaints).**
- **تحقق من أن أي بيانات seed لا تعاد تلقائياً عند بدء السيرفر أو بعد الحذف.**

---

## 9. مشاكل تسجيل الدخول كمدير (422: string_type)
### الوصف:
- اختبار test_admin_delete_any_feedback يفشل لأن بيانات login للمدير None أو غير معرفة.
- السبب: test_admin_email أو test_admin_password لم يتم تهيئتهما بنجاح.

### خطوات الحل:
- **تأكد من أن fixture admin_token تعمل وتخزن القيم في المتغيرات العامة.**
- **أضف assert test_admin_email is not None وassert test_admin_password is not None قبل login.**
- **اطبع القيم قبل استخدامها في login.**

---

## 10. مشاكل edge cases/حالات حافة أخرى
### الوصف:
- بعض الاختبارات تتوقع نتائج معينة (مثل 404 أو [] أو نتيجة فارغة) لكنها تحصل على بيانات بسبب وجود بيانات seed أو بيانات متبقية من اختبارات أخرى.

### خطوات الحل:
- **نظف قاعدة البيانات جيداً قبل كل اختبار edge case.**
- **استخدم بيانات فريدة في كل اختبار.**
- **أضف asserts واضحة مع طباعة النتائج عند الفشل.**

---

# ملخص عام وخطوات تنظيمية
1. أضف fixture لتنظيف قاعدة البيانات قبل كل اختبار أو مجموعة اختبارات.
2. استخدم بيانات فريدة دائماً (uuid4) في كل اختبار.
3. تحقق من نجاح كل عملية create قبل الاعتماد على id الناتج منها.
4. أضف asserts واضحة في بداية كل اختبار للتأكد من تهيئة التوكنات والمتغيرات العامة.
5. اطبع نصوص الأخطاء والردود الكاملة عند أي فشل في التسجيل أو login أو أي عملية مهمة.
6. راجع جميع endpoints في backend وتأكد من حماية كل ما يجب حمايته بـ Depends(get_current_user) أو get_current_admin.
7. أضف تحقق من الفلاتر والقيم غير المدعومة في backend وأرجع كود مناسب (400/422) عند الحاجة.
8. راجع جميع اختبارات edge cases وتأكد من تنظيف البيانات قبلها.

---

# ملاحظات إضافية
- إذا استمرت مشاكل 401 بعد كل ما سبق، راجع إعدادات JWT/SECRET_KEY في backend وملفات env.
- إذا استمرت مشاكل 400 عند التسجيل، راجع قيود uniqueness في قاعدة البيانات ونظفها جيداً قبل كل اختبار.
- إذا ظهرت مشاكل int_parsing/422، راجع تهيئة المتغيرات العامة (ids) وتأكد من أنها ليست None.
- إذا ظهرت مشاكل في protected endpoints، راجع headers في كل اختبار وتأكد من تمرير التوكن الصحيح.

---

# قائمة مراجعة (Checklist)
- [ ] تنظيف قاعدة البيانات قبل كل اختبار مهم
- [ ] استخدام بيانات فريدة في كل اختبار
- [ ] التأكد من تهيئة التوكنات والمتغيرات العامة
- [ ] طباعة الأخطاء والردود الكاملة عند الفشل
- [ ] حماية جميع endpoints المطلوبة
- [ ] التحقق من الفلاتر والقيم غير المدعومة
- [ ] مراجعة جميع اختبارات edge cases
- [ ] مراجعة إعدادات JWT/SECRET_KEY
- [ ] مراجعة قيود uniqueness في قاعدة البيانات
- [ ] مراجعة headers في جميع الطلبات المحمية

---

# انتهى التحليل المفصل لجميع المشاكل الحالية في اختبارات المشروع مع حلول عملية لكل منها.
