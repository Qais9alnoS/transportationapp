# إصلاح نظام التحقق من البريد الإلكتروني

تم إجراء تعديلات على نظام التحقق من البريد الإلكتروني لتسهيل عملية التطوير والاختبار. هذه التعديلات مخصصة **للتطوير فقط** ويجب تغييرها قبل نشر التطبيق في بيئة الإنتاج.

## التغييرات التي تمت

1. **وضع التطوير**: تم إضافة وضع التطوير في إعدادات البريد الإلكتروني، حيث لا يتم إرسال رسائل البريد الإلكتروني فعليًا، ولكن يتم طباعة رموز التحقق في سجلات التطبيق.

2. **قبول أي رمز تحقق**: في وضع التطوير، إذا لم يكن هناك رمز تحقق مخزن للبريد الإلكتروني، يتم قبول أي رمز يدخله المستخدم. هذا يسمح باختبار التطبيق دون الحاجة إلى إعداد خادم بريد إلكتروني حقيقي.

3. **إعدادات SMTP افتراضية**: تم إضافة إعدادات SMTP افتراضية في ملف التكوين لتسهيل عملية التطوير.

## كيفية إعداد البريد الإلكتروني في بيئة الإنتاج

### 1. تعديل ملف `dashboard_config.py`

```python
"email": {
    "enabled": True,
    "smtp_host": os.getenv("SMTP_HOST"),  # قم بتعيين خادم SMTP الخاص بك
    "smtp_port": int(os.getenv("SMTP_PORT", "587")),
    "smtp_user": os.getenv("SMTP_USER"),  # قم بتعيين اسم المستخدم الخاص بك
    "smtp_password": os.getenv("SMTP_PASSWORD"),  # قم بتعيين كلمة المرور الخاصة بك
    "development_mode": False  # قم بتعيين هذه القيمة إلى False في بيئة الإنتاج
},
```

### 2. تعديل ملف `email_service.py`

قم بإزالة الشرط الذي يقبل أي رمز تحقق في حالة عدم وجود رمز مخزن:

```python
@staticmethod
def verify_code(email: EmailStr, code: str) -> bool:
    """التحقق من صحة رمز التحقق"""
    stored_code = verification_codes.get(email)
    
    # إذا لم يكن هناك رمز مخزن، فإن الرمز غير صحيح
    if not stored_code:
        return False
    
    # التحقق من تطابق الرمز
    is_valid = stored_code == code
    
    # إذا كان الرمز صحيحًا، قم بإزالته من التخزين المؤقت
    if is_valid:
        verification_codes.pop(email, None)
    
    return is_valid
```

### 3. إعداد متغيرات البيئة

قم بإعداد متغيرات البيئة التالية في خادم الإنتاج:

```
SMTP_HOST=smtp.example.com
SMTP_PORT=587
SMTP_USER=your-email@example.com
SMTP_PASSWORD=your-password
```

### 4. تخزين رموز التحقق

في بيئة الإنتاج، يجب تخزين رموز التحقق في قاعدة بيانات مع وقت انتهاء الصلاحية، بدلاً من تخزينها في قاموس في الذاكرة. يمكن استخدام Redis أو قاعدة بيانات SQL لهذا الغرض.

## ملاحظات إضافية

- تأكد من أن خادم SMTP الخاص بك يسمح بإرسال رسائل البريد الإلكتروني من التطبيق.
- إذا كنت تستخدم Gmail، فقد تحتاج إلى إنشاء كلمة مرور للتطبيق بدلاً من استخدام كلمة مرور حسابك العادية.
- قم باختبار إرسال رسائل البريد الإلكتروني في بيئة اختبار قبل نشر التطبيق في بيئة الإنتاج.
- قم بإضافة آلية لإعادة إرسال رمز التحقق في حالة عدم وصوله إلى المستخدم.